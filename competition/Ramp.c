#pragma config(Hubs,  S1, HTMotor,  HTMotor,  HTMotor,  none)
#pragma config(Hubs,  S3, HTMotor,  HTServo,  HTServo,  none)
#pragma config(Hubs,  S4, HTServo,  none,     none,     none)
#pragma config(Sensor, S1,     ,               sensorI2CMuxController)
#pragma config(Sensor, S2,     HTSPB,          sensorI2CCustomFastSkipStates9V)
#pragma config(Sensor, S3,     ,               sensorI2CMuxController)
#pragma config(Sensor, S4,     HTMUX,          sensorI2CMuxController)
#pragma config(Motor,  mtr_S1_C1_1,     BackL,         tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C1_2,     FrontL,        tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C2_1,     motorF,        tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C2_2,     Flapper,       tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S1_C3_1,     BackR,         tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S1_C3_2,     FrontR,        tmotorTetrix, openLoop, encoder)
#pragma config(Motor,  mtr_S3_C1_1,     FanR,          tmotorTetrix, openLoop)
#pragma config(Motor,  mtr_S3_C1_2,     FanL,          tmotorTetrix, openLoop)
#pragma config(Servo,  srvo_S3_C2_1,    trailerR,             tServoStandard)
#pragma config(Servo,  srvo_S3_C2_2,    trailerL,             tServoStandard)
#pragma config(Servo,  srvo_S3_C2_3,    lift,                 tServoStandard)
#pragma config(Servo,  srvo_S3_C2_4,    rakes,                tServoStandard)
#pragma config(Servo,  srvo_S3_C2_5,    flap,                 tServoStandard)
#pragma config(Servo,  srvo_S3_C2_6,    servo12,              tServoStandard)
#pragma config(Servo,  srvo_S3_C3_1,    servo13,              tServoStandard)
#pragma config(Servo,  srvo_S3_C3_2,    spout,                tServoStandard)
#pragma config(Servo,  srvo_S3_C3_3,    faucet,               tServoStandard)
#pragma config(Servo,  srvo_S3_C3_4,    servo16,              tServoStandard)
#pragma config(Servo,  srvo_S3_C3_5,    servo17,              tServoStandard)
#pragma config(Servo,  srvo_S3_C3_6,    servo18,              tServoStandard)
#pragma config(Servo,  srvo_S4_C1_1,    foldRoller,           tServoNone)
#pragma config(Servo,  srvo_S4_C1_2,    roller,               tServoNone)
#pragma config(Servo,  srvo_S4_C1_3,    servo21,              tServoNone)
#pragma config(Servo,  srvo_S4_C1_4,    servo22,              tServoNone)
#pragma config(Servo,  srvo_S4_C1_5,    servo23,              tServoNone)
#pragma config(Servo,  srvo_S4_C1_6,    servo24,              tServoNone)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#include "PhiloDefs.h"
#include "WestCoaster.h"
#include "CenterGoalUs.h"
#include "PhiloUtils.h"
#include "JoystickDriver.c"
WestCoaster g_wcDrive;
int initHeading;

void wiggleMove()
{

	/*WestCoaster_turnWithMPU(g_wcDrive,-2,60);
	WestCoaster_controlledStraightMove(g_wcDrive, -7,25);
	WestCoaster_turnWithMPU(g_wcDrive,10,60);
	WestCoaster_controlledStraightMove(g_wcDrive, -7,25);
	WestCoaster_turnWithMPU(g_wcDrive,-2,60);*/
	WestCoaster_controlledStraightMove(g_wcDrive, -8,20);
}

void grabGoal()
{


	wiggleMove();
	goalGrabberDown();
	sleep(200);
}
void doTests();
void initializeRobot()
{

	WestCoaster_init(g_wcDrive, FrontL, FrontR, BackL, BackR, FrontL, FrontR);
	WestCoaster_initMPU(S2);
	goalGrabberUp();
		//===============
	// TESTS, comment it out for real
	//
  //doTests();

	/*servo[lift] = LIFT_BOTTOM;
	motor [Flapper] = 0;
	pinClosed();
	servo[foldRoller] = ROLLER_FOLDER_UP;
	servo[roller] = 126;
	faucetInitial();
	//move servos at maximium speed
	servoChangeRate[trailerL]=0;
	servoChangeRate[trailerR]=0;
	servoChangeRate[lift]=0;
*/
  initHeading = SuperSensors_getHeading();
	//set to true during competition to keep the grabber engaged
	bSystemLeaveServosEnabledOnProgramStop=false;

}
#define ALIGN_FAUCET_TO_CENTER 50 //milliseconds to align faucet
#define OFF_RAMP_DIST 58 //platform and ramp measure 58 inches long
#define GOAL_CENTER_TO_EDGE 11.6/2
#define FAUCET_EXTEND_BACK_CENTER GOAL_CENTER_TO_EDGE+0.5 //measure from the center of the drop to the edge of robot
void doTests()
{

	//alignToGoal(g_wcDrive, CENTER_GOAL_SONAR, 5, 15);
	//grabGoal();

	/**
	*
	***Turn and move with MPU with speed ramp up***
	***/
	while(true){
		WestCoaster_encoderObservedTurn(g_wcDrive,90);
	//WestCoaster_allMotorsPowerRot(g_wcDrive, -1080);
	sleep(1000);
	}
	//WestCoaster_controlledEncoderObservedTurn(g_wcDrive, 90-10,70);
	/*
	sleep(2000);
	WestCoaster_turnWithMPU(g_wcDrive, -20,70);
	sleep(2000);
	WestCoaster_turnWithMPU(g_wcDrive, 20,70);

/*
	sleep(2000);
  WestCoaster_moveStraightWithMPU(g_wcDrive, -110,40);
    WestCoaster_moveStraightWithMPU(g_wcDrive, -15,40);
  /*
  sleep(2000);
	WestCoaster_moveStraightWithMPU(g_wcDrive, -20,50);
	sleep(2000);
	WestCoaster_moveStraightWithMPU(g_wcDrive, 60,50);*/


	// WestCoaster_controlledEncoderObservedTurn(g_wcDrive,90,35);
	//sleep(1500);
	/*   WestCoaster_controlledEncoderObservedTurn(g_wcDrive,-90,75);
	sleep(1500);
	WestCoaster_controlledEncoderObservedTurn(g_wcDrive,180,75);
	sleep(1500);
	WestCoaster_controlledEncoderObservedTurn(g_wcDrive,-180,75);
	*/
	//	WestCoaster_controlledEncoderObservedTurn(g_wcDrive,60,35);
	//=======================================================================
	while(true){};
}
task main(){
	initializeRobot();

 // waitForStart();
	/*sleep(1000);
	servo[foldRoller] = ROLLER_FOLDER_DOWN;
	sleep(1000);
	servo[foldRoller] = ROLLER_FOLDER_UP+40;
	sleep(1000);
*/



	//go down the ramp

	//servo[lift]=LIFT_FOR_60CM;

	WestCoaster_moveStraightWithMPU(g_wcDrive, -60, 20); //from ramp
	WestCoaster_turnWithMPU(g_wcDrive,-1.5, 40);
	WestCoaster_moveStraightWithMPU(g_wcDrive, -10, 60);
	grabGoal();
  WestCoaster_turnWithMPU(g_wcDrive, -135, 40);
  WestCoaster_moveStraightWithMPU(g_wcDrive, -20, 40);
  goalGrabberUp();
  WestCoaster_moveStraightWithMPU(g_wcDrive, 16, 40);
  //WestCoaster_turnWithMPU(g_wcDrive, 140, 40);
  float current_heading = SuperSensors_getHeading();

  float delta=angleTurned(initHeading,current_heading);
	WestCoaster_turnWithMPU(g_wcDrive,-delta,40);
	WestCoaster_moveStraightWithMPU(g_wcDrive,-12, 30);
  grabGoal();
  WestCoaster_moveStraightWithMPU(g_wcDrive, 3, 40)
  WestCoaster_turnWithMPU(g_wcDrive, 5, 60);
  WestCoaster_moveStraightWithMPU(g_wcDrive,107, 60);
  WestCoaster_turnWithMPU(g_wcDrive, 50, 60);
  WestCoaster_moveStraightWithMPU(g_wcDrive, 20, 40);

  //WestCoaster_turnWithMPU(g_wcDrive, 90, 70)
	//sleep(500);
	//WestCoaster_turnWithMPU(g_wcDrive, -90, 70);
	//WestCoaster_turnWithMPU(g_wcDrive,-90,70);

	/*sleep(500);
	//zalignToGoal(g_wcDrive, CENTER_GOAL_SONAR, 5, 15);
	while(true){};
	WestCoaster_turnWithMPU(g_wcDrive,2,40);
	grabGoal();
	sleep(500);
	//drop the little one
	//liftGoUp(LIFT_FOR_60CM,5000);
	servo[faucet] = HINGE_FAUCET_FLIP;
	sleep(1000);
	pinOpen();
	sleep(500);
	//release 60cm goal
	WestCoaster_moveStraightWithMPU(g_wcDrive,4,40);
	WestCoaster_turnWithMPU(g_wcDrive,-90,40);
	WestCoaster_moveStraightWithMPU(g_wcDrive,-5,40);
	goalGrabberUp();

	//grab the 90 cm goal
	sleep(500);

	servo[lift]=LIFT_FOR_90CM;

	WestCoaster_moveStraightWithMPU(g_wcDrive,2,40);
	sleep(500);

	/** alternative
	//we check and adjust the heading
	WestCoaster_measureMPU(g_wcDrive);
	int messed = angleDifference(initHeading, g_wcDrive.global_heading);
	WestCoaster_turnWithMPU(g_wcDrive,-messed,40);
	  */
	/*WestCoaster_turnWithMPU(g_wcDrive,90,40);
	sleep(500);
	//liftGoUp(LIFT_FOR_90CM, 4000);
	sleep(500);
	WestCoaster_controlledStraightMove(g_wcDrive,-10,50);
	grabGoal();
	sleep(500);
	//drop the big one
	fansOn(5000);
	sleep(1000);

	//move all goals to parking
/*
	//try to turn right a little
	if(!WestCoaster_turnWithMPU(g_wcDrive,5,40, false, 1000)){
		  //did not finish turn, backout more
	    WestCoaster_moveStraightWithMPU(g_wcDrive,5,40);
	    //then turn again;
	    WestCoaster_turnWithMPU(g_wcDrive,5,40, false, 1000);
  }
	WestCoaster_moveStraightWithMPU(g_wcDrive,5,40);
	sleep(500);
	//now we check and adjust the heading
	WestCoaster_measureMPU(g_wcDrive);
	int messed = angleDifference(initHeading, g_wcDrive.global_heading);
#ifdef TRACE_ENABLED
	if(abs(messed)>60){
		//we messaged up the angle too much
		playSound(soundBeepBeep);
	}
#endif
	int degrees_to_park = 20-messed;
	WestCoaster_turnWithMPU(g_wcDrive,degrees_to_park,40);
	sleep(1000);
	WestCoaster_moveStraightWithMPU(g_wcDrive,120,70);
  WestCoaster_turnWithMPU(g_wcDrive,-105,40);
  WestCoaster_moveStraightWithMPU(g_wcDrive,-10,70);
  WestCoaster_turnWithMPU(g_wcDrive,-70,40);
  WestCoaster_moveStraightWithMPU(g_wcDrive,-10,70);*/

}
